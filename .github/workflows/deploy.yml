name: Deploy to Komodo

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Komodo Deployment
        env:
          WEBHOOK_URL: ${{ secrets.KOMODO_WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.KOMODO_WEBHOOK_SECRET }}
          PAYLOAD: '{"ref": "refs/heads/main", "pusher": {"name": "github-actions"}}'
        run: |
          PAYLOAD='{"ref": "refs/heads/main", "pusher": {"name": "github-actions"}}'
          
          SIGNATURE=$(python3 -c "import hmac, hashlib, os; print('sha256=' + hmac.new(os.environ['WEBHOOK_SECRET'].encode(), os.environ['PAYLOAD'].encode(), hashlib.sha256).hexdigest())" 2>/dev/null)
                  
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: $SIGNATURE" \
            -H "X-GitHub-Event: push" \
            -d "$PAYLOAD" \
            --fail